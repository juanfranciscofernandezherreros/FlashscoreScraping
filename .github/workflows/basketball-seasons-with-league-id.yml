name: Enrich Basketball Seasons (CSV Only)

on:
  workflow_dispatch:

jobs:
  enrich:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Clone basketball-data
        env:
          TOKEN_DOCKER: ${{ secrets.TOKEN_DOCKER }}
        run: |
          git clone https://x-access-token:${TOKEN_DOCKER}@github.com/juanfranciscofernandezherreros/basketball-data.git

      - name: Verify CSVs
        run: |
          test -f basketball-data/basketball_leagues.csv
          test -f src/csv/BASKETBALL_LEAGUE_SEASONS.csv

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run enrich
        run: |
          node src/enrichLeagueSeasonsWithLeagueId.js \
            leaguesSource="basketball-data/basketball_leagues.csv" \
            seasonsSource="src/csv/BASKETBALL_LEAGUE_SEASONS.csv" \
            output="src/csv/BASKETBALL_LEAGUE_SEASONS_WITH_LEAGUE_ID"

      - name: Push result
        env:
          TOKEN_DOCKER: ${{ secrets.TOKEN_DOCKER }}
        run: |
          cp src/csv/BASKETBALL_LEAGUE_SEASONS_WITH_LEAGUE_ID.csv \
             basketball-data/basketball_league_seasons_with_league_id.csv

          cd basketball-data
          git config user.name "Juan Francisco"
          git config user.email "juanfranciscofernandezherreros@gmail.com"

          git add basketball_league_seasons_with_league_id.csv
          if git diff --cached --quiet; then exit 0; fi

          git commit -m "Update enriched seasons $(date -u) [skip ci]"
          git push origin HEAD:master
