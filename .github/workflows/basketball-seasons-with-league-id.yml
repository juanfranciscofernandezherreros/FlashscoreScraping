name: Enrich Basketball Seasons (CSV Cross Only)

on:
  workflow_dispatch:

jobs:
  enrich:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clone basketball-data repo
        env:
          TOKEN_DOCKER: ${{ secrets.TOKEN_DOCKER }}
        run: |
          if [[ -z "${TOKEN_DOCKER}" ]]; then
            echo "TOKEN_DOCKER secret is required."
            exit 1
          fi
          git clone https://x-access-token:${TOKEN_DOCKER}@github.com/juanfranciscofernandezherreros/basketball-data.git

      - name: Verify required CSVs exist
        run: |
          if [[ ! -f "basketball-data/basketball_leagues.csv" ]]; then
            echo "Missing basketball_leagues.csv"
            exit 1
          fi

          if [[ ! -f "src/csv/BASKETBALL_LEAGUE_SEASONS.csv" ]]; then
            echo "Missing BASKETBALL_LEAGUE_SEASONS.csv"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run enrich script
        run: |
          node src/enrichLeagueSeasonsWithLeagueId.js \
            leaguesSource="basketball-data/basketball_leagues.csv" \
            seasonsSource="src/csv/BASKETBALL_LEAGUE_SEASONS.csv" \
            output="src/csv/BASKETBALL_LEAGUE_SEASONS_WITH_LEAGUE_ID"

      - name: Commit result to basketball-data
        env:
          TOKEN_DOCKER: ${{ secrets.TOKEN_DOCKER }}
        run: |
          set -e

          cp src/csv/BASKETBALL_LEAGUE_SEASONS_WITH_LEAGUE_ID.csv \
             basketball-data/basketball_league_seasons_with_league_id.csv

          git -C basketball-data config user.name "Juan Francisco"
          git -C basketball-data config user.email "juanfranciscofernandezherreros@gmail.com"

          git -C basketball-data add basketball_league_seasons_with_league_id.csv

          if git -C basketball-data diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git -C basketball-data commit -m "Update enriched seasons $(date -u +%Y-%m-%d) [skip ci]"
          git -C basketball-data push origin HEAD:master
